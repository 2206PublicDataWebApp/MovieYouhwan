<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StoreMapper">
	<resultMap type="Product" id="productResultMap">
		<id property="productNo" column="PRODUCT_NO" />
		<result property="productName" column="PRODUCT_NAME" />
		<result property="productType" column="PRODUCT_TYPE" />
		<result property="productPrice" column="PRODUCT_PRICE" />
		<result property="productDesc" column="PRODUCT_DESC" />
		<result property="productOrder" column="PRODUCT_ORDER" />
		<result property="productImgName" column="PRODUCT_IMG_NAME" />
		<result property="productImgRename" column="PRODUCT_IMG_RENAME" />
		<result property="productImgPath" column="PRODUCT_IMG_PATH" />
	</resultMap>
	<resultMap type="ProductType" id="productTypeResultMap">
		<id property="productTypeNo" column="PRODUCT_TYPE_NO" />
		<result property="productType" column="PRODUCT_TYPE" />
	</resultMap>
	<resultMap type="Cart" id="cartResultMap">
		<id property="cartNo" column="CART_NO" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="productNo" column="PRODUCT_NO" />
		<result property="productName" column="PRODUCT_NAME" />
		<result property="productTypeNo" column="PRODUCT_TYPE_NO" />
		<result property="productType" column="PRODUCT_TYPE" />
		<result property="productPrice" column="PRODUCT_PRICE" />		
		<result property="productCount" column="PRODUCT_COUNT" />		
		<result property="productImgRename" column="PRODUCT_IMG_RENAME" />
		<result property="productStatus" column="PRODUCT_STATUS" />
	</resultMap>
	
	<!-- 관리자 - 상품 등록 -->
	<insert id="insertProduct">
		INSERT INTO PRODUCT_TBL
		VALUES(SEQ_PRODUCT_NO.NEXTVAL, #{productName}, #{productType}, #{productPrice}, #{productDesc},
		(SELECT MAX(PRODUCT_ORDER) + 1 FROM PRODUCT_TBL), #{productImgName}, #{productImgRename}, #{productImgPath})
	</insert>
	
	<!-- 사용자 - 장바구니에 새로운 상품 담기 -->
	<insert id="insertProductToCart">
		INSERT INTO CART_TBL
		VALUES(SEQ_CART_NO.NEXTVAL, #{memberId}, #{productNo}, #{productName}, #{productTypeNo}, #{productType},
		#{productPrice}, #{productCount}, #{productImgRename}, DEFAULT)
	</insert>
	
	<!-- 사용자 - 장바구니에 있는 상품을 담으면 해당 상품 수량 증가 -->
	<update id="updateProductCountUp">
		UPDATE CART_TBL SET PRODUCT_COUNT = PRODUCT_COUNT + #{productCount}
		WHERE MEMBER_ID = #{memberId} AND PRODUCT_NO = #{productNo}
	</update>
	
	<!-- 사용자 - 장바구니에서 해당 상품 수량 변경 -->
	<update id="updateProductCountInCart">
		UPDATE CART_TBL SET PRODUCT_COUNT = #{productCount}
		WHERE CART_NO = #{cartNo}
	</update>
		
	<!-- 관리자 - 상품 수정 -->
	<update id="updateProduct">
		UPDATE PRODUCT_TBL SET PRODUCT_NAME = #{productName}, PRODUCT_TYPE = #{productType},
		PRODUCT_PRICE = ${productPrice}, PRODUCT_DESC = #{productDesc}, PRODUCT_IMG_NAME = #{productImgName},
		PRODUCT_IMG_RENAME = #{productImgRename}, PRODUCT_IMG_PATH = #{productImgPath}
		WHERE PRODUCT_NO = #{productNo}
	</update>
		
	<!-- 관리자 - 상품 재배치 -->
	<update id="updateProductOrder" parameterType="list">
		<foreach collection="list" item="item" index="index" open="DECLARE BEGIN" close="; END;" separator=";">
		UPDATE PRODUCT_TBL SET PRODUCT_ORDER = #{index}
		WHERE PRODUCT_NO = #{item}
		</foreach>
	</update>
	
	<!-- 사용자 - 장바구니에서 상품 삭제 -->
	<delete id="deleteProductsInCart">
			DELETE FROM CART_TBL WHERE CART_NO IN
			<foreach collection="list" item="item" open="(" close=")" separator=",">
			#{item}
			</foreach>
	</delete>
	
	<!-- 관리자 - 상품 삭제 -->
	<delete id="deleteProduct">
		DELETE FROM PRODUCT_TBL WHERE PRODUCT_NO = #{productNo}
	</delete>
	
	<!-- 공통 - 상품 목록 조회 -->
	<select id="selectProductList" resultMap="productResultMap">
		SELECT PRODUCT_NO, PRODUCT_NAME, PRODUCT_TYPE, PRODUCT_PRICE, PRODUCT_DESC, PRODUCT_IMG_RENAME
		FROM PRODUCT_TBL
		ORDER BY PRODUCT_ORDER ASC
	</select>
	
	<!-- 공통 - 상품 유형 목록 조회 -->
	<select id="selectProductTypeList" resultMap="productTypeResultMap">
		SELECT DISTINCT PRODUCT_TYPE_NO, PRODUCT_TYPE FROM PRODUCT_TYPE_TBL
		JOIN PRODUCT_TBL USING (PRODUCT_TYPE) ORDER BY PRODUCT_TYPE_NO ASC
	</select>
	
	<!-- 공통 - 상품 상세 조회 -->
	<select id="selectOneProduct" resultMap="productResultMap">
		SELECT *
		FROM PRODUCT_TBL
		WHERE PRODUCT_NO = #{productNo}
	</select>
	
	<!-- 사용자 - 장바구니에 있는 특정 상품 개수 조회 -->
	<select id="selectCountProductInCart" resultType="_int">
		SELECT COUNT(CART_NO) FROM CART_TBL
		WHERE MEMBER_ID = #{memberId} AND PRODUCT_NO = #{productNo}
	</select>
	
	<select id="selectProductCount" resultType="_int">
		SELECT PRODUCT_COUNT FROM CART_TBL
		WHERE CART_NO = #{cartNo}
	</select>
	
	<!-- 사용자 - 장바구니 조회 -->
	<select id="selectMyCartList" resultMap="cartResultMap">
		SELECT CART_NO, MEMBER_ID, PRODUCT_NO, PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_COUNT, PRODUCT_IMG_RENAME, PRODUCT_STATUS
		FROM CART_TBL
		WHERE MEMBER_ID = #{memberId}
	</select>
	
	<!-- 사용자 - 장바구니에서 선택한 상품 조회 -->
	<select id="selectCheckedCartList" resultMap="cartResultMap">
		SELECT * FROM CART_TBL WHERE CART_NO IN
		<foreach collection="array" item="item" open="(" close=")" separator=",">
		#{item}
		</foreach>
	</select>
</mapper>